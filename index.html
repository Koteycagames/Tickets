<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credits Mini-Games</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --bg: #1e1e2e;
            --surface: #2d2d44;
            --text: #ffffff;
            --danger: #ff7675;
            --success: #55efc4;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 20px;
            text-align: center;
        }

        .screen.active {
            display: flex;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã UI */
        input {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
            width: 80%;
            max-width: 300px;
            background: var(--surface);
            color: white;
            outline: none;
        }

        button {
            padding: 12px 24px;
            margin: 10px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            width: 80%;
            max-width: 300px;
            position: relative; /* –î–ª—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º */
        #header {
            display: none; /* –°–∫—Ä—ã—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞ */
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background: var(--surface);
            justify-content: space-between;
            align-items: center;
        }

        .profile-btn-icon {
            background: #444;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è */
        #profile-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .modal-content {
            background: var(--surface);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 350px;
            text-align: left;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        .stat-row {
            margin: 15px 0;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .stat-label {
            color: #aaa;
            font-size: 14px;
        }

        /* –ò–≥—Ä—ã */
        .game-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 15px;
            margin: 10px;
            width: 100%;
            max-width: 300px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .game-card:hover {
            border-color: var(--primary);
        }

        .coin {
            width: 100px;
            height: 100px;
            background: #ffd700;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: #b8860b;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* –†–µ–∫–ª–∞–º–∞ */
        #ad-container {
            margin-top: auto;
            background: #000;
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 5px 0;
            min-height: 90px;
        }

        /* –õ–æ–∞–¥–µ—Ä (–∫—Ä—É–∂–æ—á–µ–∫) */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        
        .btn-text.hidden {
            visibility: hidden;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        #result-msg {
            height: 24px;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="header">
        <div class="profile-btn-icon" onclick="openProfile()">üë§</div>
        <div style="font-weight: bold;">–ë–∞–ª–∞–Ω—Å: <span id="header-balance">...</span> T</div>
    </div>

    <div id="auth-screen" class="screen active">
        <h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="handleLogin()" id="login-btn">
            <span class="btn-text">–í–æ–π—Ç–∏</span>
            <div class="loader"></div>
        </button>
        <button onclick="handleRegister()" style="background: var(--surface);">
            <span class="btn-text">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            <div class="loader"></div>
        </button>
        <p id="auth-error" style="color: var(--danger); font-size: 14px;"></p>
    </div>

    <div id="menu-screen" class="screen">
        <h2>–ú–∏–Ω–∏-–ò–≥—Ä—ã</h2>
        <div class="game-card" onclick="openGame('coinflip')">
            <h3>ü™ô –ú–æ–Ω–µ—Ç–∫–∞</h3>
            <p>–†–∏—Å–∫: 3 –¢–∏–∫–µ—Ç–∞</p>
            <p>–ù–∞–≥—Ä–∞–¥–∞: 5 –¢–∏–∫–µ—Ç–æ–≤</p>
        </div>
        </div>

    <div id="coinflip-screen" class="screen">
        <button onclick="showScreen('menu-screen')" style="background: transparent; width: auto; position: absolute; top: 60px; left: 10px;">‚¨Ö –ù–∞–∑–∞–¥</button>
        <h2>–û—Ä–µ–ª –∏–ª–∏ –†–µ—à–∫–∞?</h2>
        <div class="coin" id="coin-visual">$</div>
        <p>–°—Ç–æ–∏–º–æ—Å—Ç—å –∏–≥—Ä—ã: <b>3 –¢–∏–∫–µ—Ç–∞</b></p>
        <p>–í—ã–∏–≥—Ä—ã—à: <b>5 –¢–∏–∫–µ—Ç–æ–≤</b></p>
        <div id="result-msg"></div>
        
        <button onclick="playCoinFlip()" id="play-btn">
            <span class="btn-text">–û–ü–õ–ê–¢–ò–¢–¨ –ò –ò–ì–†–ê–¢–¨</span>
            <div class="loader"></div>
        </button>
    </div>

    <div id="profile-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeProfile()">&times;</span>
            <h2>–ü—Ä–æ—Ñ–∏–ª—å –ò–≥—Ä–æ–∫–∞</h2>
            
            <div class="stat-row">
                <div class="stat-label">Standoff ID</div>
                <b id="profile-id">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            </div>
            
            <div class="stat-row">
                <div class="stat-label">Email</div>
                <span id="profile-email">...</span>
            </div>

            <div class="stat-row">
                <div class="stat-label">–ë–∞–ª–∞–Ω—Å</div>
                <span id="profile-balance" style="color: var(--success)">...</span> –¢–∏–∫–µ—Ç–æ–≤
            </div>

            <button onclick="handleLogout()" style="width: 100%; background: var(--danger); margin: 20px 0 0 0;">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div id="ad-container">
        <script>
            atOptions = {
              'key' : 'ba5b233760526a810caa77cf17293467',
              'format' : 'iframe',
              'height' : 90,
              'width' : 728,
              'params' : {}
            };
        </script>
        <script type="text/javascript" src="https://avenuenineteenthendorsement.com/ba5b233760526a810caa77cf17293467/invoke.js"></script>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, get, set, runTransaction, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyDvKy3Ij9zeHOl2lwyrCAuDd-60pLZhQUc",
            authDomain: "credits-f2ca3.firebaseapp.com",
            databaseURL: "https://credits-f2ca3-default-rtdb.firebaseio.com",
            projectId: "credits-f2ca3",
            storageBucket: "credits-f2ca3.firebasestorage.app",
            messagingSenderId: "178991466300",
            appId: "1:178991466300:web:962c6b299f5d4e56ef4039"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUserData = null;

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI ---
        window.showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–µ–¥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞
            if(screenId === 'auth-screen') {
                document.getElementById('header').style.display = 'none';
            } else {
                document.getElementById('header').style.display = 'flex';
            }
        };

        window.toggleLoading = (btnId, isLoading) => {
            const btn = document.getElementById(btnId);
            const text = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.loader');
            
            if (isLoading) {
                text.classList.add('hidden');
                loader.style.display = 'block';
                btn.disabled = true;
            } else {
                text.classList.remove('hidden');
                loader.style.display = 'none';
                btn.disabled = false;
            }
        };

        // --- –õ–æ–≥–∏–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª, –≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
                const userRef = ref(db, 'users/' + user.uid);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        currentUserData = snapshot.val();
                        updateUI(user.email, currentUserData);
                        showScreen('menu-screen');
                    } else {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (–æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏), —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ
                         console.error("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                    }
                });
            } else {
                showScreen('auth-screen');
                currentUserData = null;
            }
        });

        window.handleRegister = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorP = document.getElementById('auth-error');
            
            if(pass.length < 6) { errorP.innerText = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6+ —Å–∏–º–≤–æ–ª–æ–≤"; return; }

            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—ç—Ç–æ –≤—Ç–æ—Ä–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –±–ª–æ–∫–µ)
            const regBtn = document.querySelectorAll('#auth-screen button')[1]; 
            // –î–æ–±–∞–≤–∏–º ID –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤ HTML –≤—ã—à–µ, –Ω–æ –∑–¥–µ—Å—å –Ω–∞–π–¥–µ–º —Ç–∞–∫ –∏–ª–∏ —á–µ—Ä–µ–∑ this –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ –í–æ–π—Ç–∏, —Ç–∞–∫ –∫–∞–∫ —É –≤—Ç–æ—Ä–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–µ—Ç ID –≤ –∫–æ–¥–µ –≤—ã—à–µ
            // –î–∞–≤–∞–π –¥–æ–±–∞–≤–∏–º ID –∫–Ω–æ–ø–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ HTML? –Ø –Ω–µ –º–æ–≥—É –º–µ–Ω—è—Ç—å HTML, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É—é querySelector
            
            errorP.innerText = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...";
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø ID (–¢–†–ê–ù–ó–ê–ö–¶–ò–Ø) ---
                const counterRef = ref(db, 'meta/userCount');
                
                // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: —á–∏—Ç–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º
                const result = await runTransaction(counterRef, (currentCount) => {
                    if (currentCount === null) return 100000; // –ü–µ—Ä–≤—ã–π —é–∑–µ—Ä
                    return currentCount + 1;
                });

                const newId = result.snapshot.val();

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞
                await set(ref(db, 'users/' + user.uid), {
                    email: email,
                    balance: 50, // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å
                    gameId: newId
                });

            } catch (error) {
                errorP.innerText = error.message;
            }
        };

        window.handleLogin = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorP = document.getElementById('auth-error');

            window.toggleLoading('login-btn', true);

            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => {
                    errorP.innerText = "–û—à–∏–±–∫–∞: " + error.message;
                    window.toggleLoading('login-btn', false);
                });
        };

        window.handleLogout = () => {
            signOut(auth);
            closeProfile();
        };

        function updateUI(email, data) {
            document.getElementById('header-balance').innerText = data.balance;
            document.getElementById('profile-email').innerText = email;
            document.getElementById('profile-balance').innerText = data.balance;
            document.getElementById('profile-id').innerText = data.gameId || "–û—à–∏–±–∫–∞";
        }

        // --- –ü—Ä–æ—Ñ–∏–ª—å ---
        window.openProfile = () => { document.getElementById('profile-modal').style.display = 'flex'; };
        window.closeProfile = () => { document.getElementById('profile-modal').style.display = 'none'; };

        // --- –ò–≥—Ä—ã ---
        window.openGame = (game) => {
            if(game === 'coinflip') showScreen('coinflip-screen');
        };

        // --- –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã "–ú–æ–Ω–µ—Ç–∫–∞" ---
        window.playCoinFlip = async () => {
            const cost = 3;
            const reward = 5;
            const msg = document.getElementById('result-msg');
            const visual = document.getElementById('coin-visual');

            if (!currentUserData || currentUserData.balance < cost) {
                msg.innerText = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤!";
                msg.style.color = "var(--danger)";
                return;
            }

            // 1. –í–∏–∑—É–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–û–ø–ª–∞—Ç–∞)
            window.toggleLoading('play-btn', true);
            msg.innerText = "";
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏/–æ–ø–ª–∞—Ç—ã (1 —Å–µ–∫—É–Ω–¥–∞)
            await new Promise(r => setTimeout(r, 1000));

            // 2. –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã
            const isWin = Math.random() < 0.5; // 50% —à–∞–Ω—Å
            
            const userRef = ref(db, 'users/' + auth.currentUser.uid);

            // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
            await runTransaction(userRef, (user) => {
                if (user) {
                    user.balance -= cost; // –°–Ω–∏–º–∞–µ–º –æ–ø–ª–∞—Ç—É
                    if (isWin) {
                        user.balance += reward; // –ù–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
                    }
                }
                return user;
            }).then((result) => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                currentUserData = result.snapshot.val();
                updateUI(auth.currentUser.email, currentUserData);

                // –ê–Ω–∏–º–∞—Ü–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                window.toggleLoading('play-btn', false);
                
                if (isWin) {
                    visual.innerText = "üèÜ";
                    msg.innerText = "–ü–û–ë–ï–î–ê! (+5 —Ç–∏–∫–µ—Ç–æ–≤)";
                    msg.style.color = "var(--success)";
                } else {
                    visual.innerText = "‚ùå";
                    msg.innerText = "–ü—Ä–æ–∏–≥—Ä—ã—à...";
                    msg.style.color = "var(--danger)";
                }
                
                // –°–±—Ä–æ—Å –∏–∫–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
                setTimeout(() => visual.innerText = "$", 2000);
            });
        };

    </script>
</body>
</html>
